<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DPMods Admin - JSON Manager</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&family=JetBrains+Mono:wght[400]&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* === GLOBAL VARIABLES (Purple Glass Theme) === */
        :root {
            --bg-color: #10051a;
            --glass: rgba(40, 10, 50, 0.7);
            --glass-border: rgba(187, 102, 255, 0.25);
            --primary: #bb66ff; 
            --text: #ffffff;
            --text-muted: #d1d1d1;
            --input-bg: rgba(255, 255, 255, 0.05);
            --radius: 14px;
            --font: 'Poppins', sans-serif;
            --blur: blur(16px);
            --padding: 18px;
        }

        body {
            background-color: var(--bg-color);
            background-image: radial-gradient(circle at 90% 10%, rgba(187, 102, 255, 0.1), transparent 40%),
                              radial-gradient(circle at 10% 90%, rgba(50, 20, 80, 0.4), transparent 40%);
            color: var(--text); font-family: var(--font); 
            margin: 0; padding-bottom: 90px;
            overflow-x: hidden;
            display: flex; flex-direction: column; min-height: 100vh;
        }

        /* --- LAYOUT --- */
        .app-main { display: flex; flex-grow: 1; width: 100%; }
        .tab-wrapper { flex-grow: 1; padding: 0; }
        .tab-content { display: none; padding: var(--padding); max-width: 900px; margin: 0 auto; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- HEADER --- */
        header { 
            position: sticky; top: 0; z-index: 100; 
            background: rgba(16, 5, 26, 0.9); backdrop-filter: var(--blur); 
            padding: var(--padding); border-bottom: 1px solid var(--glass-border);
        }
        .top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .brand { font-size: 1.3rem; font-weight: 600; display: flex; align-items: center; gap: 10px; }
        .action-btn { width: 42px; height: 42px; border-radius: 10px; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: var(--text); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
        .action-btn:active { transform: scale(0.95); }

        .search-wrap { display: flex; gap: 10px; height: 48px; }
        .search-box { flex: 1; background: var(--input-bg); border: 1px solid var(--glass-border); border-radius: 12px; display: flex; align-items: center; padding: 0 15px; }
        .search-box input { font-size: 0.95rem; background: none; border: none; color: white; flex: 1; outline: none; font-family: var(--font); margin-left: 10px; }
        
        /* --- CARDS --- */
        .glass-card { background: var(--glass); backdrop-filter: var(--blur); border: 1px solid var(--glass-border); border-radius: var(--radius); padding: 20px; margin-bottom: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); }
        .card-head { font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1.2px; color: var(--primary); font-weight: 700; border-bottom: 1px solid var(--glass-border); padding-bottom: 12px; margin-bottom: 18px; display: flex; align-items: center; gap: 8px; }

        /* --- USER LIST ITEM --- */
        .user-item { 
            background: rgba(255, 255, 255, 0.03); 
            border: 1px solid var(--glass-border); 
            border-radius: 12px; 
            padding: 16px; 
            margin-bottom: 12px; 
            display: flex; justify-content: space-between; align-items: center; 
            transition: 0.2s; cursor: pointer; position: relative;
        }
        .user-item:hover { background: rgba(255, 255, 255, 0.06); transform: translateY(-2px); }
        
        .u-info h4 { font-size: 1rem; margin: 0 0 6px 0; display: flex; align-items: center; gap: 8px; font-family: 'JetBrains Mono', monospace; }
        .u-tags { display: flex; gap: 6px; flex-wrap: wrap; }
        .tag { font-size: 0.7rem; padding: 4px 10px; border-radius: 6px; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); color: var(--text-muted); }
        
        .u-actions { display: flex; gap: 15px; }
        .u-actions i { font-size: 1.1rem; color: var(--text-muted); transition: 0.2s; }
        .u-actions i:hover { color: var(--primary); }

        /* --- FORMS --- */
        .input-grp { margin-bottom: 15px; }
        .input-grp label { display: block; font-size: 0.8rem; margin-bottom: 6px; color: var(--text-muted); font-weight: 500; }
        .inp { 
            width: 100%; padding: 14px; font-size: 0.95rem; border-radius: 12px; 
            background: var(--input-bg); border: 1px solid var(--glass-border); 
            color: white; font-family: 'JetBrains Mono', monospace; 
            box-sizing: border-box; outline: none; transition: 0.3s;
        }
        .inp:focus { border-color: var(--primary); background: rgba(255,255,255,0.08); }
        
        select.inp { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 15px center; }
        select.inp option { background: #1a0823; color: white; padding: 10px; }

        /* --- NAV & FAB --- */
        .navbar { position: fixed; bottom: 0; width: 100%; height: 70px; background: rgba(10, 5, 26, 0.95); backdrop-filter: blur(10px); border-top: 1px solid var(--glass-border); display: flex; justify-content: space-around; align-items: center; z-index: 900; }
        .nav-btn { text-align: center; color: var(--text-muted); font-size: 0.65rem; flex: 1; transition: 0.3s; cursor: pointer; }
        .nav-btn i { font-size: 1.2rem; display: block; margin-bottom: 4px; }
        .nav-btn.active { color: var(--primary); transform: translateY(-3px); }

        .sidebar { display: none; position: sticky; top: 0; width: 240px; padding: 20px 0; background: rgba(10, 5, 26, 0.8); border-right: 1px solid var(--glass-border); height: 100vh; }
        .side-btn { display: flex; align-items: center; padding: 16px 25px; color: var(--text-muted); cursor: pointer; transition: 0.2s; font-size: 0.95rem; gap: 15px; }
        .side-btn:hover, .side-btn.active { background: rgba(187, 102, 255, 0.15); color: var(--primary); border-left: 3px solid var(--primary); }

        @media (min-width: 900px) {
            body { padding-bottom: 0; }
            .navbar { display: none; }
            .sidebar { display: block; }
            .tab-wrapper { padding: 20px 40px; }
            .fab-stack { bottom: 30px; right: 30px; }
        }

        /* --- MODALS --- */
        .fab-stack { position: fixed; bottom: 90px; right: 20px; display: flex; flex-direction: column; gap: 15px; z-index: 950; }
        .fab { width: 56px; height: 56px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 1.4rem; color: white; border: none; cursor: pointer; background: var(--primary); box-shadow: 0 8px 20px rgba(0,0,0,0.5); transition: 0.3s; }
        .fab:active { transform: scale(0.9); }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); display: none; justify-content: center; align-items: center; z-index: 10000; }
        .modal-box { 
            background: #150520; width: 90%; max-width: 420px; padding: 30px; 
            border-radius: 24px; border: 1px solid var(--glass-border); 
            box-shadow: 0 20px 50px rgba(0,0,0,0.8); max-height: 90vh; overflow-y: auto;
            animation: modalPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
        }
        @keyframes modalPop { 0% { opacity: 0; transform: scale(0.9); } 100% { opacity: 1; transform: scale(1); } }
        
        .modal-btn-row { display: flex; justify-content: flex-end; gap: 12px; margin-top: 25px; }
        .m-btn { padding: 12px 24px; border-radius: 12px; font-weight: 600; cursor: pointer; border: none; font-size: 0.9rem; }
        .m-save { background: var(--primary); color: white; }
        .m-close { background: rgba(255,255,255,0.1); color: var(--text-muted); }

        /* Loader & Toast */
        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); z-index: 11000; display: none; justify-content: center; align-items: center; flex-direction: column; gap: 15px; color: var(--primary); }
        #toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: var(--primary); color: white; padding: 12px 24px; border-radius: 50px; font-size: 0.9rem; font-weight: 500; box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 11000; opacity: 0; transition: 0.3s; pointer-events: none; white-space: nowrap; }
    </style>
</head>
<body onload="initApp()">

    <div id="toast">Notification</div>
    <div id="loader"><i class="fas fa-circle-notch fa-spin fa-2x"></i><span>Syncing Data...</span></div>

    <div id="setupModal" class="modal-overlay" style="z-index: 20000;">
        <div class="modal-box">
            <div class="card-head"><i class="fas fa-plug"></i> Connect GitHub</div>
            <p style="font-size: 0.85rem; color: #ccc; margin-bottom: 20px;">
                Enter your GitHub details to manage your JSON file. These are saved locally.
            </p>
            <div class="input-grp"><label>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</label><input type="password" id="set_token" class="inp" placeholder="ghp_..."></div>
            <div class="input-grp"><label>Efat9/Admin-panel-pro</label><input type="text" id="set_repo" class="inp" placeholder="DPModsYT/animkeylogspanel"></div>
            <div class="input-grp"><label>Branch</label><input type="text" id="set_branch" class="inp" value="main"></div>
            <div class="input-grp"><label>File Path</label><input type="text" id="set_file" class="inp" value="Key.json"></div>
            <div class="modal-btn-row">
                <button class="m-btn m-save" onclick="saveSetup()">Connect & Load</button>
            </div>
        </div>
    </div>

    <header>
        <div class="top-row">
            <div class="brand"><i class="fas fa-shield-halved"></i> DPMods JSON (GitHub)</div>
            <div style="display:flex; gap:10px">
                 <div class="action-btn" onclick="clearSetup()" title="Logout"><i class="fas fa-sign-out-alt"></i></div>
                 <div class="action-btn" onclick="loadData()" title="Sync"><i class="fas fa-sync-alt"></i></div>
            </div>
        </div>
        <div class="search-wrap">
            <div class="search-box">
                <i class="fas fa-search" style="opacity:0.5"></i>
                <input type="text" id="search" placeholder="Search users..." oninput="renderUsers()">
            </div>
        </div>
    </header>
    
    <div class="app-main">
        <nav class="sidebar">
            <div class="side-btn active" onclick="nav('users', this)"><i class="fas fa-users"></i> Users</div>
            <div class="side-btn" onclick="nav('general', this)"><i class="fas fa-cogs"></i> General</div>
            <div class="side-btn" onclick="nav('texts', this)"><i class="fas fa-envelope-open-text"></i> Texts</div>
            <div class="side-btn" onclick="nav('bans', this)"><i class="fas fa-ban"></i> Bans</div>
        </nav>

        <div class="tab-wrapper">
            <div id="tab-users" class="tab-content active">
                <div id="usersList"></div>
            </div>

            <div id="tab-general" class="tab-content">
                <div class="glass-card">
                    <div class="card-head"><i class="fas fa-globe"></i> Main Config</div>
                    <div class="input-grp"><label>App Status</label><select id="g_status" class="inp select-styled"><option value="active">Active</option><option value="inactive">Inactive</option><option value="maintenance">Maintenance</option></select></div>
                    <div class="input-grp"><label>Latest Version Date (DD/MM/YYYY)</label><input type="text" id="g_ver_date" class="inp"></div>
                    <div class="input-grp"><label>Update URL</label><input type="text" id="g_up_url" class="inp"></div>
                    <div class="input-grp"><label>Admin Contact URL</label><input type="text" id="g_ad_url" class="inp"></div>
                </div>
                <div class="glass-card">
                    <div class="card-head"><i class="fas fa-clock"></i> Time Settings</div>
                    <div class="input-grp"><label>Primary Time API</label><input type="text" id="g_time" class="inp"></div>
                    <div class="input-grp"><label>Backup Time API</label><input type="text" id="g_time_bk" class="inp"></div>
                    <div class="modal-btn-row"><button class="m-btn m-save" onclick="saveAllData()">Save Config</button></div>
                </div>
            </div>

            <div id="tab-texts" class="tab-content">
                <div class="glass-card">
                    <div class="card-head"><i class="fas fa-align-left"></i> App Messages</div>
                    <div class="input-grp"><label>Login Button</label><input type="text" id="t_login" class="inp"></div>
                    <div class="input-grp"><label>Admin Button</label><input type="text" id="t_admin" class="inp"></div>
                    <div class="input-grp"><label>Update Button</label><input type="text" id="t_up" class="inp"></div>
                    <div class="input-grp"><label>Remember Checkbox</label><input type="text" id="t_rem" class="inp"></div>
                    <hr style="border-color:var(--glass-border); margin: 20px 0;">
                    <div class="input-grp"><label>Banned Message</label><textarea id="t_ban_msg" class="inp" rows="2"></textarea></div>
                    <div class="input-grp"><label>Expired Message</label><textarea id="t_exp_msg" class="inp" rows="2"></textarea></div>
                    <div class="input-grp"><label>Internet Error</label><textarea id="t_net_msg" class="inp" rows="2"></textarea></div>
                    <div class="input-grp"><label>Update Available</label><input type="text" id="t_up_msg" class="inp"></div>
                    <div class="modal-btn-row"><button class="m-btn m-save" onclick="saveAllData()">Save Texts</button></div>
                </div>
            </div>

            <div id="tab-bans" class="tab-content">
                <div class="glass-card">
                    <div class="card-head"><i class="fas fa-user-slash"></i> Device Blacklist</div>
                    <p style="font-size:0.8rem; color:var(--text-muted); margin-bottom:10px;">Enter one Device ID per line.</p>
                    <div class="input-grp"><textarea id="b_list" class="inp" rows="10" placeholder="device_id_1&#10;device_id_2"></textarea></div>
                    <div class="modal-btn-row"><button class="m-btn m-save" onclick="saveAllData()">Save Blacklist</button></div>
                </div>
            </div>
        </div>
    </div>

    <nav class="navbar">
        <div class="nav-btn active" onclick="nav('users', this)"><i class="fas fa-users"></i>Users</div>
        <div class="nav-btn" onclick="nav('general', this)"><i class="fas fa-cogs"></i>Gen</div>
        <div class="nav-btn" onclick="nav('texts', this)"><i class="fas fa-envelope"></i>Texts</div>
        <div class="nav-btn" onclick="nav('bans', this)"><i class="fas fa-ban"></i>Bans</div>
    </nav>

    <div class="fab-stack">
        <button class="fab" onclick="openUserModal()"><i class="fas fa-user-plus"></i></button>
    </div>

    <div id="userModal" class="modal-overlay">
        <div class="modal-box">
            <div class="card-head">User Manager</div>
            <div class="input-grp"><label>Username</label><input type="text" id="mu_user" class="inp"></div>
            <div class="input-grp"><label>Password</label><input type="text" id="mu_pass" class="inp"></div>
            <div class="input-grp"><label>Expiry Date (DD/MM/YYYY)</label><input type="text" id="mu_exp" class="inp" placeholder="30/12/2030"></div>
            <div class="input-grp"><label>Allowed Devices (Comma sep or 'ALL')</label><textarea id="mu_dev" class="inp" rows="2"></textarea></div>
            <div class="input-grp"><label>Success Toast</label><input type="text" id="mu_toast" class="inp"></div>
            <div class="modal-btn-row">
                <button class="m-btn m-close" onclick="closeM('userModal')">Cancel</button>
                <button class="m-btn m-save" onclick="saveUser()">Save User</button>
            </div>
        </div>
    </div>

    <script>
        // === CREDENTIALS HANDLING ===
        let CREDENTIALS = {
            token: '', repo: '', branch: 'main', file: 'Key.json'
        };

        // Standard JSON Structure (Fallback)
        let DATA = {
            status: "active",
            latest_version_date: "",
            update_url: "",
            admin_url: "",
            time_api: "",
            time_api_backup: "",
            texts: {},
            banned_devices: [],
            users: []
        };
        
        let EDIT_INDEX = -1; // For tracking which user is being edited

        function toast(msg, err=false) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.style.background = err ? '#ff4d4d' : '#bb66ff';
            t.style.opacity = 1; t.style.transform = 'translate(-50%, -5px)';
            setTimeout(()=> { t.style.opacity = 0; t.style.transform = 'translate(-50%, 0)'; }, 3000);
        }

        // === INIT & SETUP ===
        function initApp() {
            const saved = localStorage.getItem('dpmods_creds');
            if(saved) {
                CREDENTIALS = JSON.parse(saved);
                loadData();
            } else {
                document.getElementById('setupModal').style.display = 'flex';
            }
        }

        function saveSetup() {
            const t = document.getElementById('set_token').value.trim();
            const r = document.getElementById('set_repo').value.trim();
            const b = document.getElementById('set_branch').value.trim();
            const f = document.getElementById('set_file').value.trim();

            if(!t || !r) return alert("Token and Repo are required");

            CREDENTIALS = { token: t, repo: r, branch: b, file: f };
            localStorage.setItem('dpmods_creds', JSON.stringify(CREDENTIALS));
            document.getElementById('setupModal').style.display = 'none';
            loadData();
        }

        function clearSetup() {
            if(confirm("Logout and clear credentials?")) {
                localStorage.removeItem('dpmods_creds');
                location.reload();
            }
        }

        // === API LOGIC ===
        async function loadData() {
            document.getElementById('loader').style.display = 'flex';
            const API = `https://api.github.com/repos/${CREDENTIALS.repo}/contents/${CREDENTIALS.file}`;
            
            try {
                const r = await fetch(`${API}?ref=${CREDENTIALS.branch}`, { 
                    headers: { 
                        'Authorization': `token ${CREDENTIALS.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    } 
                });
                
                if(r.status === 404) {
                    toast("File not found. Creating new on Save.", true);
                    renderAll();
                    document.getElementById('loader').style.display = 'none';
                    return;
                }
                
                if(!r.ok) throw new Error("GitHub Error: " + r.status);
                
                const j = await r.json();
                const content = JSON.parse(atob(j.content));
                DATA = content;
                
                // Safe checks
                if(!DATA.users) DATA.users = [];
                if(!DATA.texts) DATA.texts = {};
                if(!DATA.banned_devices) DATA.banned_devices = [];

                renderAll();
                toast("Data Synced");
            } catch(e) {
                console.error(e);
                toast("Load Error. Check Config.", true);
                document.getElementById('setupModal').style.display = 'flex'; // Show setup on error
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        }

        async function saveAllData() {
            // 1. Gather GENERAL
            DATA.status = document.getElementById('g_status').value;
            DATA.latest_version_date = document.getElementById('g_ver_date').value;
            DATA.update_url = document.getElementById('g_up_url').value;
            DATA.admin_url = document.getElementById('g_ad_url').value;
            DATA.time_api = document.getElementById('g_time').value;
            DATA.time_api_backup = document.getElementById('g_time_bk').value;

            // 2. Gather TEXTS
            DATA.texts.login_btn = document.getElementById('t_login').value;
            DATA.texts.admin_btn = document.getElementById('t_admin').value;
            DATA.texts.update_btn = document.getElementById('t_up').value;
            DATA.texts.remember_text = document.getElementById('t_rem').value;
            DATA.texts.banned_msg = document.getElementById('t_ban_msg').value;
            DATA.texts.expired_msg = document.getElementById('t_exp_msg').value;
            DATA.texts.internet_error = document.getElementById('t_net_msg').value;
            DATA.texts.update_msg = document.getElementById('t_up_msg').value;

            // 3. Gather BANS
            const banRaw = document.getElementById('b_list').value;
            DATA.banned_devices = banRaw.split('\n').map(x=>x.trim()).filter(x=>x);

            // 4. USERS are already in DATA.users (updated by saveUser)

            // PUSH TO GITHUB
            document.getElementById('loader').style.display = 'flex';
            const API = `https://api.github.com/repos/${CREDENTIALS.repo}/contents/${CREDENTIALS.file}`;

            try {
                // Get SHA of existing file (if exists)
                let sha = '';
                try {
                    const existing = await fetch(`${API}?ref=${CREDENTIALS.branch}`, {
                        headers: { 
                            'Authorization': `token ${CREDENTIALS.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    if (existing.ok) {
                        const existingData = await existing.json();
                        sha = existingData.sha;
                    }
                } catch (e) { 
                    // New file, no SHA needed
                }

                const payload = {
                    message: "Update from Admin Panel",
                    branch: CREDENTIALS.branch,
                    content: btoa(JSON.stringify(DATA, null, 2))
                };

                // If file exists, add SHA
                if (sha) {
                    payload.sha = sha;
                }
                
                const r = await fetch(API, {
                    method: 'PUT',
                    headers: { 
                        'Authorization': `token ${CREDENTIALS.token}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify(payload)
                });
                
                if(!r.ok) {
                    const errorData = await r.json();
                    throw new Error("Save Failed: " + (errorData.message || r.status));
                }
                
                toast("Changes Saved!");
            } catch(e) {
                console.error(e);
                toast("Save Failed: " + e.message, true);
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        }

        // === RENDERERS ===
        function renderAll() {
            renderUsers();

            // General
            document.getElementById('g_status').value = DATA.status || 'active';
            document.getElementById('g_ver_date').value = DATA.latest_version_date || '';
            document.getElementById('g_up_url').value = DATA.update_url || '';
            document.getElementById('g_ad_url').value = DATA.admin_url || '';
            document.getElementById('g_time').value = DATA.time_api || '';
            document.getElementById('g_time_bk').value = DATA.time_api_backup || '';

            // Texts
            const t = DATA.texts || {};
            document.getElementById('t_login').value = t.login_btn || '';
            document.getElementById('t_admin').value = t.admin_btn || '';
            document.getElementById('t_up').value = t.update_btn || '';
            document.getElementById('t_rem').value = t.remember_text || '';
            document.getElementById('t_ban_msg').value = t.banned_msg || '';
            document.getElementById('t_exp_msg').value = t.expired_msg || '';
            document.getElementById('t_net_msg').value = t.internet_error || '';
            document.getElementById('t_up_msg').value = t.update_msg || '';

            // Bans
            document.getElementById('b_list').value = (DATA.banned_devices || []).join('\n');
        }

        function renderUsers() {
            const list = document.getElementById('usersList');
            list.innerHTML = '';
            const query = document.getElementById('search').value.toLowerCase();
            
            // Filter
            const filtered = DATA.users.map((u, index) => ({...u, originalIndex: index}))
                                       .filter(u => u.username.toLowerCase().includes(query));

            if(filtered.length === 0) {
                list.innerHTML = `<div style="text-align:center; padding:40px; opacity:0.5">No Users Found</div>`;
                return;
            }

            filtered.forEach(u => {
                const devCount = u.allowed_devices.includes("ALL") ? "ALL" : u.allowed_devices.length;
                
                list.innerHTML += `
                <div class="user-item" onclick="editUser(${u.originalIndex})">
                    <div class="u-info">
                        <h4><i class="fas fa-user"></i> ${u.username}</h4>
                        <div class="u-tags">
                            <span class="tag">Exp: ${u.expiry_date}</span>
                            <span class="tag">Devs: ${devCount}</span>
                        </div>
                    </div>
                    <div class="u-actions">
                        <i class="fas fa-pen"></i>
                        <i class="fas fa-trash" onclick="event.stopPropagation(); delUser(${u.originalIndex})"></i>
                    </div>
                </div>`;
            });
        }

        // === USER CRUD ===
        function openUserModal() {
            EDIT_INDEX = -1; // New User
            document.getElementById('mu_user').value = '';
            document.getElementById('mu_pass').value = '';
            document.getElementById('mu_exp').value = '';
            document.getElementById('mu_dev').value = 'ALL';
            document.getElementById('mu_toast').value = 'Login Successful';
            document.getElementById('userModal').style.display = 'flex';
        }

        function editUser(index) {
            EDIT_INDEX = index;
            const u = DATA.users[index];
            document.getElementById('mu_user').value = u.username;
            document.getElementById('mu_pass').value = u.password;
            document.getElementById('mu_exp').value = u.expiry_date;
            document.getElementById('mu_dev').value = u.allowed_devices.join(', ');
            document.getElementById('mu_toast').value = u.success_toast;
            document.getElementById('userModal').style.display = 'flex';
        }

        function saveUser() {
            const userObj = {
                username: document.getElementById('mu_user').value,
                password: document.getElementById('mu_pass').value,
                expiry_date: document.getElementById('mu_exp').value,
                allowed_devices: document.getElementById('mu_dev').value.split(',').map(x=>x.trim()).filter(x=>x),
                success_toast: document.getElementById('mu_toast').value
            };

            if(!userObj.username) return toast("Username required", true);

            if(EDIT_INDEX === -1) {
                DATA.users.push(userObj);
            } else {
                DATA.users[EDIT_INDEX] = userObj;
            }

            closeM('userModal');
            renderUsers();
            saveAllData();
        }

        function delUser(index) {
            if(confirm("Delete User?")) {
                DATA.users.splice(index, 1);
                renderUsers();
                saveAllData();
            }
        }

        // === NAVIGATION ===
        function closeM(id) { document.getElementById(id).style.display = 'none'; }
        
        function nav(id, el) {
            document.querySelectorAll('.tab-content').forEach(x=>x.classList.remove('active'));
            document.getElementById('tab-'+id).classList.add('active');
            
            document.querySelectorAll('.nav-btn, .side-btn').forEach(x=>x.classList.remove('active'));
            
            const side = document.querySelector(`.side-btn[onclick*="'${id}'"]`);
            const bot = document.querySelector(`.nav-btn[onclick*="'${id}'"]`);
            if(side) side.classList.add('active');
            if(bot) bot.classList.add('active');
        }
    </script>
</body>
    </html>
